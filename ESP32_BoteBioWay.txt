#include "BluetoothSerial.h"
#include <ESP32Servo.h>

#if !defined(CONFIG_BT_ENABLED) || !defined(CONFIG_BLUEDROID_ENABLED)
#error Bluetooth is not enabled! Please run `make menuconfig` to enable it
#endif

BluetoothSerial SerialBT;
String dispositivoNombre = "ESP32_Detector";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PINES SERVOS (NO MODIFICAR)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const int servo13Pin = 13;  // Servo de GIRO
const int servo12Pin = 12;  // Servo de INCLINACIÃ“N (trabaja con 14)
const int servo14Pin = 14;  // Servo de INCLINACIÃ“N (trabaja con 12)

// Objetos Servo
Servo servo13;
Servo servo12;
Servo servo14;

// Posiciones actuales (permiten negativos)
int posicionGiro = -80;      // Servo 13: -80 a 160 (real: 0 a 180)
int posicionInclinacion = 0; // Servos 12 y 14: -45 a 45 (movimiento conjunto)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PINES SENSORES ULTRASÃ“NICOS HC-SR04
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sensor PLÃSTICO
const int TRIG_PLASTICO = 25;
const int ECHO_PLASTICO = 26;

// Sensor PAPEL/CARTÃ“N
const int TRIG_PAPEL = 27;
const int ECHO_PAPEL = 32;

// Sensor ALUMINIO/METAL
const int TRIG_ALUMINIO = 33;
const int ECHO_ALUMINIO = 23;

// Sensor GENERAL
const int TRIG_GENERAL = 19;
const int ECHO_GENERAL = 18;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N SENSORES ULTRASÃ“NICOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const float DISTANCIA_FONDO = 82.5;    // Distancia sensor â†’ fondo del bote (cm)
const float UMBRAL_LLENO = 25.0;       // Distancia sensor â†’ basura cuando estÃ¡ lleno (cm)
const float ESPACIO_UTIL = 57.5;       // DISTANCIA_FONDO - UMBRAL_LLENO (cm)
const int OBJETOS_PARA_MEDICION = 10;  // Cada cuÃ¡ntos objetos medir niveles

// Contador de objetos depositados
int contadorObjetos = 0;

// Ãšltimas mediciones (en cm desde el sensor)
float nivelPlastico = DISTANCIA_FONDO;
float nivelPapel = DISTANCIA_FONDO;
float nivelAluminio = DISTANCIA_FONDO;
float nivelGeneral = DISTANCIA_FONDO;

void setup() {
  Serial.begin(115200);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONFIGURAR SERVOS (NO MODIFICAR)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  servo13.attach(servo13Pin, 400, 2600);
  servo12.attach(servo12Pin);
  servo14.attach(servo14Pin);

  // PosiciÃ³n inicial (brazo hacia arriba, permite +/-45Â° de inclinaciÃ³n)
  servo13.write(0);      // Giro en posiciÃ³n inicial (real 0Â°)
  servo12.write(135);    // PosiciÃ³n neutra para permitir movimiento en ambas direcciones
  servo14.write(45);     // PosiciÃ³n neutra para permitir movimiento en ambas direcciones
  posicionGiro = -80;
  posicionInclinacion = 0;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONFIGURAR SENSORES ULTRASÃ“NICOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PLÃSTICO
  pinMode(TRIG_PLASTICO, OUTPUT);
  pinMode(ECHO_PLASTICO, INPUT);

  // PAPEL/CARTÃ“N
  pinMode(TRIG_PAPEL, OUTPUT);
  pinMode(ECHO_PAPEL, INPUT);

  // ALUMINIO/METAL
  pinMode(TRIG_ALUMINIO, OUTPUT);
  pinMode(ECHO_ALUMINIO, INPUT);

  // GENERAL
  pinMode(TRIG_GENERAL, OUTPUT);
  pinMode(ECHO_GENERAL, INPUT);

  Serial.println("\n\n");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("       ESP32 BOTE BIOWAY - PRODUCCIÃ“N");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("Servos inicializados:");
  Serial.println("  - Servo 13 (GIRO): 0Â° (posiciÃ³n -80)");
  Serial.println("  - Servo 12 (INCLINACIÃ“N): 135Â° (neutro)");
  Serial.println("  - Servo 14 (INCLINACIÃ“N): 45Â° (neutro)");
  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
  Serial.println("Sensores ultrasÃ³nicos inicializados:");
  Serial.println("  - PLÃSTICO:       TRIG=GPIO25, ECHO=GPIO26");
  Serial.println("  - PAPEL/CARTÃ“N:   TRIG=GPIO27, ECHO=GPIO32");
  Serial.println("  - ALUMINIO/METAL: TRIG=GPIO33, ECHO=GPIO23");
  Serial.println("  - GENERAL:        TRIG=GPIO19, ECHO=GPIO18");
  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
  Serial.println("ConfiguraciÃ³n de niveles:");
  Serial.print("  - Distancia al fondo: ");
  Serial.print(DISTANCIA_FONDO);
  Serial.println(" cm");
  Serial.print("  - Umbral 'lleno': ");
  Serial.print(UMBRAL_LLENO);
  Serial.println(" cm");
  Serial.print("  - MediciÃ³n cada: ");
  Serial.print(OBJETOS_PARA_MEDICION);
  Serial.println(" objetos");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("COMANDOS SOPORTADOS:");
  Serial.println("");
  Serial.println("  PING              â†’ Handshake (responde PONG)");
  Serial.println("");
  Serial.println("  DEPOSITAR:G,I     â†’ Ejecutar secuencia completa de depÃ³sito");
  Serial.println("                      G = giro (-80 a 160)");
  Serial.println("                      I = inclinaciÃ³n (-45 a 45)");
  Serial.println("                      Ejemplo: DEPOSITAR:-30,-45");
  Serial.println("                      Ejecuta: GIROâ†’INCLâ†’depositarâ†’RESET");
  Serial.println("                      Responde: LISTO cuando termina");
  Serial.println("                      Cada 10 objetos mide niveles automÃ¡ticamente");
  Serial.println("");
  Serial.println("  CategorÃ­as predefinidas:");
  Serial.println("    PLASTICO:      DEPOSITAR:-30,-45");
  Serial.println("    PAPEL/CARTON:  DEPOSITAR:-30,45");
  Serial.println("    ALUMINIO/METAL:DEPOSITAR:59,-45");
  Serial.println("    GENERAL:       DEPOSITAR:59,45");
  Serial.println("");
  Serial.println("  GIRO:XXX      â†’ Mover servo 13 a posiciÃ³n XXX (-80 a 160)");
  Serial.println("                  Ejemplo: GIRO:90 o GIRO:-45");
  Serial.println("");
  Serial.println("  INCL:XXX      â†’ Mover servos 12 y 14 juntos (-45 a 45)");
  Serial.println("                  Servo 12: 135 - XXX");
  Serial.println("                  Servo 14: 45 + XXX");
  Serial.println("                  Ejemplo: INCL:45 o INCL:-45");
  Serial.println("");
  Serial.println("  RESET         â†’ Volver a posiciÃ³n inicial");
  Serial.println("");
  Serial.println("  MEDIR         â†’ Forzar mediciÃ³n de niveles (4 sensores)");
  Serial.println("                  Responde: NIVELES:P,PP,A,G");
  Serial.println("");
  Serial.println("  CONTADOR      â†’ Ver contador actual de objetos");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  // Inicializar Bluetooth
  SerialBT.begin(dispositivoNombre);
  Serial.println("ğŸ“¡ Bluetooth: " + dispositivoNombre);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("âœ… SISTEMA LISTO");
  Serial.println("â³ Esperando conexiÃ³n del celular...");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  // Verificar si hay datos disponibles por Bluetooth
  if (SerialBT.available()) {
    String comando = SerialBT.readStringUntil('\n');
    comando.trim();

    if (comando.length() > 0) {
      procesarComando(comando);
    }
  }

  // TambiÃ©n leer del Serial para pruebas locales
  if (Serial.available()) {
    String comando = Serial.readStringUntil('\n');
    comando.trim();

    if (comando.length() > 0) {
      procesarComando(comando);
    }
  }

  delay(50);
}

void procesarComando(String comando) {
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.print("ğŸ“¥ Comando recibido: ");
  Serial.println(comando);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  // PING - Handshake
  if (comando == "PING") {
    SerialBT.println("PONG");
    SerialBT.flush();
    Serial.println("ğŸ¤ Handshake: PONG enviado");
    return;
  }

  // DEPOSITAR:GIRO,INCLINACION - Secuencia completa de depÃ³sito
  // Formato: DEPOSITAR:-30,-45 (valores numÃ©ricos directos)
  // Responde LISTO cuando termina (comunicaciÃ³n bidireccional precisa)
  if (comando.startsWith("DEPOSITAR:")) {
    String datos = comando.substring(10);

    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.print("ğŸ¯ DEPOSITAR recibido: ");
    Serial.println(datos);
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // Parsear valores GIRO,INCLINACION del comando
    int giro = 59;       // Default: General
    int inclinacion = 45;

    // Buscar la coma que separa giro e inclinaciÃ³n
    int comaIndex = datos.indexOf(',');

    if (comaIndex > 0) {
      // Formato nuevo: DEPOSITAR:GIRO,INCLINACION (ej: DEPOSITAR:-30,-45)
      String giroStr = datos.substring(0, comaIndex);
      String inclStr = datos.substring(comaIndex + 1);

      giro = giroStr.toInt();
      inclinacion = inclStr.toInt();

      Serial.println("ğŸ“Š Valores parseados directamente:");
      Serial.print("   Giro: ");
      Serial.print(giro);
      Serial.println("Â°");
      Serial.print("   InclinaciÃ³n: ");
      Serial.print(inclinacion);
      Serial.println("Â°");

      // Identificar categorÃ­a para el log
      if (giro == -30 && inclinacion == -45) {
        Serial.println("ğŸ“¦ CategorÃ­a: PLÃSTICO");
      } else if (giro == -30 && inclinacion == 45) {
        Serial.println("ğŸ“„ CategorÃ­a: PAPEL/CARTÃ“N");
      } else if (giro == 59 && inclinacion == -45) {
        Serial.println("ğŸ¥« CategorÃ­a: ALUMINIO/METAL");
      } else if (giro == 59 && inclinacion == 45) {
        Serial.println("ğŸ—‘ï¸ CategorÃ­a: GENERAL");
      } else {
        Serial.println("âš™ï¸ CategorÃ­a: PERSONALIZADA");
      }

    } else {
      // Formato antiguo: DEPOSITAR:CATEGORIA (compatibilidad hacia atrÃ¡s)
      String categoria = datos;
      categoria.toUpperCase();

      Serial.println("ğŸ“Š Formato antiguo (por nombre):");

      if (categoria.indexOf("PLASTICO") >= 0 || categoria.indexOf("PLASTIC") >= 0) {
        giro = -30;
        inclinacion = -45;
        Serial.println("ğŸ“¦ CategorÃ­a: PLÃSTICO");
      } else if (categoria.indexOf("PAPEL") >= 0 || categoria.indexOf("CARTON") >= 0) {
        giro = -30;
        inclinacion = 45;
        Serial.println("ğŸ“„ CategorÃ­a: PAPEL/CARTÃ“N");
      } else if (categoria.indexOf("ALUMINIO") >= 0 || categoria.indexOf("METAL") >= 0) {
        giro = 59;
        inclinacion = -45;
        Serial.println("ğŸ¥« CategorÃ­a: ALUMINIO/METAL");
      } else {
        giro = 59;
        inclinacion = 45;
        Serial.println("ğŸ—‘ï¸ CategorÃ­a: GENERAL");
      }
    }

    // Validar rangos
    if (giro < -80) giro = -80;
    if (giro > 160) giro = 160;
    if (inclinacion < -45) inclinacion = -45;
    if (inclinacion > 45) inclinacion = 45;

    Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    Serial.print("ğŸ¯ Ejecutando: GIRO=");
    Serial.print(giro);
    Serial.print("Â°, INCL=");
    Serial.print(inclinacion);
    Serial.println("Â°");
    Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EJECUTAR SECUENCIA COMPLETA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Paso 1: Girar a posiciÃ³n
    Serial.print("ğŸ“ Paso 1/5: Girando a ");
    Serial.print(giro);
    Serial.println("Â°...");
    moverGiro(giro);
    delay(1000);

    // Paso 2: Inclinar
    Serial.print("ğŸ“ Paso 2/5: Inclinando a ");
    Serial.print(inclinacion);
    Serial.println("Â°...");
    moverInclinacion(inclinacion);
    delay(1000);

    // Paso 3: Mantener posiciÃ³n (depositando)
    Serial.println("ğŸ“ Paso 3/5: Depositando material...");
    delay(400);

    // Paso 4: Volver inclinaciÃ³n a 0
    Serial.println("ğŸ“ Paso 4/5: Volviendo inclinaciÃ³n a 0Â°...");
    moverInclinacion(0);
    delay(1000);

    // Paso 5: Volver giro a posiciÃ³n inicial
    Serial.println("ğŸ“ Paso 5/5: Volviendo a posiciÃ³n inicial...");
    moverGiro(-80);
    delay(500);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INCREMENTAR CONTADOR DE OBJETOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    contadorObjetos++;
    Serial.print("ğŸ“Š Contador de objetos: ");
    Serial.print(contadorObjetos);
    Serial.print("/");
    Serial.println(OBJETOS_PARA_MEDICION);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VERIFICAR SI TOCA MEDIR NIVELES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (contadorObjetos >= OBJETOS_PARA_MEDICION) {
      Serial.println("\nğŸ”” Â¡10 objetos depositados! Midiendo niveles...");
      medirYEnviarNiveles();
      contadorObjetos = 0;  // Resetear contador
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECUENCIA COMPLETADA - ENVIAR LISTO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println("âœ… DEPÃ“SITO COMPLETADO");
    Serial.println("ğŸ“¤ Enviando: LISTO");
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    SerialBT.println("LISTO");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // GIRO:XXX - Mover servo 13 (soporta negativos)
  if (comando.startsWith("GIRO:")) {
    String valorStr = comando.substring(5);
    int valor = valorStr.toInt();

    // Validar rango (-80 a 160)
    if (valor < -80) valor = -80;
    if (valor > 160) valor = 160;

    // Convertir a Ã¡ngulo de servo (0-180)
    // -80 -> servo 0, 0 -> servo 80, 160 -> servo 240 (limitado a 180)
    int anguloServo = valor + 80;  // Offset para que -80 sea 0
    if (anguloServo > 180) anguloServo = 180;
    if (anguloServo < 0) anguloServo = 0;

    Serial.print("ğŸ”„ Moviendo GIRO (Servo 13) a: ");
    Serial.print(valor);
    Serial.print("Â° (servo real: ");
    Serial.print(anguloServo);
    Serial.println("Â°)");

    // Movimiento directo (mÃ¡xima velocidad)
    servo13.write(anguloServo);
    posicionGiro = valor;

    delay(300);  // PequeÃ±a espera para que llegue

    Serial.println("âœ… GIRO completado");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // INCL:XXX - Mover servos 12 y 14 juntos (soporta negativos)
  // Los servos estÃ¡n espalda con espalda, por eso uno sube cuando el otro baja
  //
  // POSICIÃ“N NEUTRA (brazo hacia arriba): S12=135Â°, S14=45Â°
  //
  // Para inclinar hacia ADELANTE (+45Â°):
  //   S12: 135 - 45 = 90Â° (baja)
  //   S14: 45 + 45 = 90Â° (sube)
  //
  // Para inclinar hacia ATRÃS (-45Â°):
  //   S12: 135 - (-45) = 180Â° (sube)
  //   S14: 45 + (-45) = 0Â° (baja)
  //
  if (comando.startsWith("INCL:")) {
    String valorStr = comando.substring(5);
    int valor = valorStr.toInt();

    // Validar rango (-45 a 45)
    if (valor < -45) valor = -45;
    if (valor > 45) valor = 45;

    // Calcular posiciones desde la posiciÃ³n neutra (S12=135, S14=45)
    // S12 baja cuando inclinamos hacia adelante (valor positivo)
    // S14 sube cuando inclinamos hacia adelante (valor positivo)
    int pos12 = 135 - valor;  // +45 â†’ 90Â°, -45 â†’ 180Â°
    int pos14 = 45 + valor;   // +45 â†’ 90Â°, -45 â†’ 0Â°

    // Limitar a rangos vÃ¡lidos del servo (0-180)
    if (pos12 > 180) pos12 = 180;
    if (pos12 < 0) pos12 = 0;
    if (pos14 > 180) pos14 = 180;
    if (pos14 < 0) pos14 = 0;

    Serial.print("ğŸ”„ Moviendo INCLINACIÃ“N a: ");
    Serial.print(valor);
    Serial.println("Â°");
    Serial.print("   Servo 12: ");
    Serial.print(pos12);
    Serial.println("Â°");
    Serial.print("   Servo 14: ");
    Serial.print(pos14);
    Serial.println("Â°");

    servo12.write(pos12);
    servo14.write(pos14);
    posicionInclinacion = valor;

    delay(300);  // PequeÃ±a espera para que lleguen

    Serial.println("âœ… INCLINACIÃ“N completada");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // RESET - Volver a posiciÃ³n inicial
  if (comando == "RESET") {
    Serial.println("ğŸ”„ Reseteando a posiciÃ³n inicial...");

    servo13.write(0);
    servo12.write(135);
    servo14.write(45);
    posicionGiro = -80;
    posicionInclinacion = 0;

    delay(500);

    Serial.println("âœ… PosiciÃ³n inicial restaurada");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // MEDIR - Forzar mediciÃ³n de niveles
  if (comando == "MEDIR") {
    Serial.println("ğŸ“ Forzando mediciÃ³n de niveles...");
    medirYEnviarNiveles();
    return;
  }

  // CONTADOR - Ver contador actual
  if (comando == "CONTADOR") {
    Serial.print("ğŸ“Š Contador actual: ");
    Serial.print(contadorObjetos);
    Serial.print("/");
    Serial.println(OBJETOS_PARA_MEDICION);

    String respuesta = "CONTADOR:" + String(contadorObjetos);
    SerialBT.println(respuesta);
    SerialBT.flush();
    return;
  }

  // Comando no reconocido
  Serial.println("âŒ Comando no reconocido");
  Serial.println("   Comandos vÃ¡lidos: PING, DEPOSITAR:G,I, GIRO:XXX, INCL:XXX, RESET, MEDIR, CONTADOR");
  SerialBT.println("ERROR");
  SerialBT.flush();
}

void mostrarPosicionActual() {
  Serial.println("\nğŸ“ PosiciÃ³n actual:");
  Serial.print("   GIRO (Servo 13): ");
  Serial.print(posicionGiro);
  Serial.println("Â°");
  Serial.print("   INCLINACIÃ“N: ");
  Serial.print(posicionInclinacion);
  Serial.print("Â° (S12:");
  Serial.print(135 - posicionInclinacion);
  Serial.print("Â°, S14:");
  Serial.print(45 + posicionInclinacion);
  Serial.println("Â°)");
  Serial.println("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES AUXILIARES PARA MOVIMIENTO DE SERVOS (NO MODIFICAR)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Mover servo de GIRO (servo 13) a posiciÃ³n especificada
 * @param valor: posiciÃ³n deseada (-80 a 160)
 */
void moverGiro(int valor) {
  // Validar rango (-80 a 160)
  if (valor < -80) valor = -80;
  if (valor > 160) valor = 160;

  // Convertir a Ã¡ngulo de servo (0-180)
  int anguloServo = valor + 80;
  if (anguloServo > 180) anguloServo = 180;
  if (anguloServo < 0) anguloServo = 0;

  servo13.write(anguloServo);
  posicionGiro = valor;
}

/**
 * Mover servos de INCLINACIÃ“N (servos 12 y 14) a posiciÃ³n especificada
 * Los servos estÃ¡n espalda con espalda
 * @param valor: posiciÃ³n deseada (-45 a 45)
 */
void moverInclinacion(int valor) {
  // Validar rango (-45 a 45)
  if (valor < -45) valor = -45;
  if (valor > 45) valor = 45;

  // Calcular posiciones desde la posiciÃ³n neutra (S12=135, S14=45)
  int pos12 = 135 - valor;
  int pos14 = 45 + valor;

  // Limitar a rangos vÃ¡lidos del servo (0-180)
  if (pos12 > 180) pos12 = 180;
  if (pos12 < 0) pos12 = 0;
  if (pos14 > 180) pos14 = 180;
  if (pos14 < 0) pos14 = 0;

  servo12.write(pos12);
  servo14.write(pos14);
  posicionInclinacion = valor;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES SENSORES ULTRASÃ“NICOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Medir distancia con un sensor ultrasÃ³nico HC-SR04
 * @param trigPin: Pin TRIG del sensor
 * @param echoPin: Pin ECHO del sensor
 * @return: Distancia en centÃ­metros
 */
float medirDistancia(int trigPin, int echoPin) {
  // Asegurar que TRIG estÃ¡ en LOW
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);

  // Enviar pulso de 10Âµs
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  // Leer duraciÃ³n del pulso ECHO (timeout de 30ms = ~5m mÃ¡ximo)
  long duracion = pulseIn(echoPin, HIGH, 30000);

  // Si no hay respuesta (timeout), retornar distancia mÃ¡xima
  if (duracion == 0) {
    return DISTANCIA_FONDO;
  }

  // Calcular distancia: velocidad del sonido = 343 m/s = 0.0343 cm/Âµs
  // Dividir entre 2 porque el sonido va y vuelve
  float distancia = (duracion * 0.0343) / 2.0;

  // Limitar a rango vÃ¡lido
  if (distancia > DISTANCIA_FONDO) distancia = DISTANCIA_FONDO;
  if (distancia < 2.0) distancia = 2.0;  // MÃ­nimo del sensor HC-SR04

  return distancia;
}

/**
 * Medir todos los sensores y enviar resultados por Bluetooth
 * Formato: NIVELES:XX.X,XX.X,XX.X,XX.X (PlÃ¡stico,Papel,Aluminio,General)
 * Si alguno estÃ¡ lleno: ALERTA_LLENO:CATEGORIA
 */
void medirYEnviarNiveles() {
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("           ğŸ“ MIDIENDO NIVELES DE BOTES");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  // Medir cada sensor con pequeÃ±a pausa entre mediciones
  nivelPlastico = medirDistancia(TRIG_PLASTICO, ECHO_PLASTICO);
  delay(50);

  nivelPapel = medirDistancia(TRIG_PAPEL, ECHO_PAPEL);
  delay(50);

  nivelAluminio = medirDistancia(TRIG_ALUMINIO, ECHO_ALUMINIO);
  delay(50);

  nivelGeneral = medirDistancia(TRIG_GENERAL, ECHO_GENERAL);

  // Mostrar resultados en Serial
  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
  Serial.println("  CATEGORIA      | DISTANCIA | LLENADO | ESTADO");
  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

  mostrarNivelCategoria("PLASTICO", nivelPlastico);
  mostrarNivelCategoria("PAPEL", nivelPapel);
  mostrarNivelCategoria("ALUMINIO", nivelAluminio);
  mostrarNivelCategoria("GENERAL", nivelGeneral);

  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

  // Enviar niveles por Bluetooth
  // Formato: NIVELES:P,PP,A,G (distancias en cm, 1 decimal)
  String mensaje = "NIVELES:";
  mensaje += String(nivelPlastico, 1) + ",";
  mensaje += String(nivelPapel, 1) + ",";
  mensaje += String(nivelAluminio, 1) + ",";
  mensaje += String(nivelGeneral, 1);

  SerialBT.println(mensaje);
  SerialBT.flush();

  Serial.print("ğŸ“¤ Enviado: ");
  Serial.println(mensaje);

  // Verificar si algÃºn bote estÃ¡ lleno (â‰¤ UMBRAL_LLENO cm)
  bool hayAlerta = false;
  String alertas = "";

  if (nivelPlastico <= UMBRAL_LLENO) {
    alertas += "PLASTICO,";
    hayAlerta = true;
  }
  if (nivelPapel <= UMBRAL_LLENO) {
    alertas += "PAPEL,";
    hayAlerta = true;
  }
  if (nivelAluminio <= UMBRAL_LLENO) {
    alertas += "ALUMINIO,";
    hayAlerta = true;
  }
  if (nivelGeneral <= UMBRAL_LLENO) {
    alertas += "GENERAL,";
    hayAlerta = true;
  }

  // Enviar alertas si hay botes llenos
  if (hayAlerta) {
    // Quitar Ãºltima coma
    alertas = alertas.substring(0, alertas.length() - 1);

    String mensajeAlerta = "ALERTA_LLENO:" + alertas;
    SerialBT.println(mensajeAlerta);
    SerialBT.flush();

    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println("âš ï¸  Â¡ALERTA! BOTES LLENOS DETECTADOS");
    Serial.print("ğŸ“¤ Enviado: ");
    Serial.println(mensajeAlerta);
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  }

  Serial.println("");
}

/**
 * Mostrar nivel de una categorÃ­a en formato tabla
 */
void mostrarNivelCategoria(String categoria, float distancia) {
  // Calcular porcentaje de llenado
  // distancia = 82.5 â†’ 0% lleno (vacÃ­o)
  // distancia = 25.0 â†’ 100% lleno
  float porcentaje = ((DISTANCIA_FONDO - distancia) / ESPACIO_UTIL) * 100.0;
  if (porcentaje < 0) porcentaje = 0;
  if (porcentaje > 100) porcentaje = 100;

  // Determinar estado
  String estado;
  if (distancia <= UMBRAL_LLENO) {
    estado = "!! LLENO!";
  } else if (porcentaje >= 75) {
    estado = "Casi lleno";
  } else if (porcentaje >= 50) {
    estado = "Medio";
  } else if (porcentaje >= 25) {
    estado = "Bajo";
  } else {
    estado = "Vacio";
  }

  // Formatear lÃ­nea
  Serial.print("  ");
  Serial.print(categoria);
  // Padding para alinear columnas
  for (int i = categoria.length(); i < 14; i++) Serial.print(" ");
  Serial.print("| ");
  Serial.print(distancia, 1);
  Serial.print(" cm");
  if (distancia < 10) Serial.print(" ");
  Serial.print("  | ");
  Serial.print(porcentaje, 0);
  Serial.print("%");
  if (porcentaje < 10) Serial.print(" ");
  if (porcentaje < 100) Serial.print(" ");
  Serial.print("    | ");
  Serial.println(estado);
}
