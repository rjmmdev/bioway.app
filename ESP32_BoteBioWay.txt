#include "BluetoothSerial.h"
#include <ESP32Servo.h>

#if !defined(CONFIG_BT_ENABLED) || !defined(CONFIG_BLUEDROID_ENABLED)
#error Bluetooth is not enabled! Please run `make menuconfig` to enable it
#endif

BluetoothSerial SerialBT;
String dispositivoNombre = "ESP32_Detector";

// Pines para los tres servos
const int servo13Pin = 13;  // Servo de GIRO
const int servo12Pin = 12;  // Servo de INCLINACIÃ“N (trabaja con 14)
const int servo14Pin = 14;  // Servo de INCLINACIÃ“N (trabaja con 12)

// Objetos Servo
Servo servo13;
Servo servo12;
Servo servo14;

// Posiciones actuales (permiten negativos)
int posicionGiro = -80;      // Servo 13: -80 a 160 (real: 0 a 180)
int posicionInclinacion = 0; // Servos 12 y 14: -45 a 45 (movimiento conjunto)

void setup() {
  Serial.begin(115200);

  // Configurar los tres servos
  // Servo 13: Rango mÃ¡ximo de pulso para mÃ¡ximo torque
  servo13.attach(servo13Pin, 400, 2600);
  servo12.attach(servo12Pin);
  servo14.attach(servo14Pin);

  // PosiciÃ³n inicial (brazo hacia arriba, permite +/-45Â° de inclinaciÃ³n)
  servo13.write(0);      // Giro en posiciÃ³n inicial (real 0Â°)
  servo12.write(135);    // PosiciÃ³n neutra para permitir movimiento en ambas direcciones
  servo14.write(45);     // PosiciÃ³n neutra para permitir movimiento en ambas direcciones
  posicionGiro = -80;
  posicionInclinacion = 0;

  Serial.println("\n\n");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("       ESP32 BOTE BIOWAY - PRODUCCIÃ“N");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("Servos inicializados:");
  Serial.println("  - Servo 13 (GIRO): 0Â° (posiciÃ³n -80)");
  Serial.println("  - Servo 12 (INCLINACIÃ“N): 135Â° (neutro)");
  Serial.println("  - Servo 14 (INCLINACIÃ“N): 45Â° (neutro)");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("COMANDOS SOPORTADOS:");
  Serial.println("");
  Serial.println("  PING          â†’ Handshake (responde PONG)");
  Serial.println("");
  Serial.println("  DEPOSITAR:CAT â†’ Ejecutar secuencia completa de depÃ³sito");
  Serial.println("                  CAT = PLASTICO, PAPEL, ALUMINIO, GENERAL");
  Serial.println("                  Ejecuta: GIROâ†’INCLâ†’depositarâ†’RESET");
  Serial.println("                  Responde: LISTO cuando termina");
  Serial.println("");
  Serial.println("  GIRO:XXX      â†’ Mover servo 13 a posiciÃ³n XXX (-80 a 160)");
  Serial.println("                  Ejemplo: GIRO:90 o GIRO:-45");
  Serial.println("");
  Serial.println("  INCL:XXX      â†’ Mover servos 12 y 14 juntos (-45 a 45)");
  Serial.println("                  Servo 12: 135 - XXX");
  Serial.println("                  Servo 14: 45 + XXX");
  Serial.println("                  Ejemplo: INCL:45 o INCL:-45");
  Serial.println("");
  Serial.println("  RESET         â†’ Volver a posiciÃ³n inicial");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  // Inicializar Bluetooth
  SerialBT.begin(dispositivoNombre);
  Serial.println("ğŸ“¡ Bluetooth: " + dispositivoNombre);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("âœ… SISTEMA LISTO");
  Serial.println("â³ Esperando conexiÃ³n del celular...");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  // Verificar si hay datos disponibles por Bluetooth
  if (SerialBT.available()) {
    String comando = SerialBT.readStringUntil('\n');
    comando.trim();

    if (comando.length() > 0) {
      procesarComando(comando);
    }
  }

  // TambiÃ©n leer del Serial para pruebas locales
  if (Serial.available()) {
    String comando = Serial.readStringUntil('\n');
    comando.trim();

    if (comando.length() > 0) {
      procesarComando(comando);
    }
  }

  delay(50);
}

void procesarComando(String comando) {
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.print("ğŸ“¥ Comando recibido: ");
  Serial.println(comando);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  // PING - Handshake
  if (comando == "PING") {
    SerialBT.println("PONG");
    SerialBT.flush();
    Serial.println("ğŸ¤ Handshake: PONG enviado");
    return;
  }

  // DEPOSITAR:CATEGORIA - Secuencia completa de depÃ³sito
  // Responde LISTO cuando termina (comunicaciÃ³n bidireccional precisa)
  if (comando.startsWith("DEPOSITAR:")) {
    String categoria = comando.substring(10);
    categoria.toUpperCase();

    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.print("ğŸ¯ DEPOSITAR: ");
    Serial.println(categoria);
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // Determinar movimientos segÃºn categorÃ­a
    int giro = 59;       // Default: General
    int inclinacion = 45;

    if (categoria.indexOf("PLASTICO") >= 0 || categoria.indexOf("PLASTIC") >= 0) {
      // PLÃSTICO: Giro -30Â°, Incl -45Â°
      giro = -30;
      inclinacion = -45;
      Serial.println("ğŸ“¦ CategorÃ­a: PLÃSTICO");
    } else if (categoria.indexOf("PAPEL") >= 0 || categoria.indexOf("CARTON") >= 0) {
      // PAPEL/CARTÃ“N: Giro -30Â°, Incl +45Â°
      giro = -30;
      inclinacion = 45;
      Serial.println("ğŸ“„ CategorÃ­a: PAPEL/CARTÃ“N");
    } else if (categoria.indexOf("ALUMINIO") >= 0 || categoria.indexOf("METAL") >= 0) {
      // ALUMINIO/METAL: Giro 59Â°, Incl -45Â°
      giro = 59;
      inclinacion = -45;
      Serial.println("ğŸ¥« CategorÃ­a: ALUMINIO/METAL");
    } else {
      // GENERAL/BASURA: Giro 59Â°, Incl +45Â°
      giro = 59;
      inclinacion = 45;
      Serial.println("ğŸ—‘ï¸ CategorÃ­a: GENERAL");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EJECUTAR SECUENCIA COMPLETA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Paso 1: Girar a posiciÃ³n
    Serial.print("ğŸ“ Paso 1/5: Girando a ");
    Serial.print(giro);
    Serial.println("Â°...");
    moverGiro(giro);
    delay(1000);

    // Paso 2: Inclinar
    Serial.print("ğŸ“ Paso 2/5: Inclinando a ");
    Serial.print(inclinacion);
    Serial.println("Â°...");
    moverInclinacion(inclinacion);
    delay(1000);

    // Paso 3: Mantener posiciÃ³n (depositando)
    Serial.println("ğŸ“ Paso 3/5: Depositando material...");
    delay(400);

    // Paso 4: Volver inclinaciÃ³n a 0
    Serial.println("ğŸ“ Paso 4/5: Volviendo inclinaciÃ³n a 0Â°...");
    moverInclinacion(0);
    delay(1000);

    // Paso 5: Volver giro a posiciÃ³n inicial
    Serial.println("ğŸ“ Paso 5/5: Volviendo a posiciÃ³n inicial...");
    moverGiro(-80);
    delay(500);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECUENCIA COMPLETADA - ENVIAR LISTO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println("âœ… DEPÃ“SITO COMPLETADO");
    Serial.println("ğŸ“¤ Enviando: LISTO");
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    SerialBT.println("LISTO");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // GIRO:XXX - Mover servo 13 (soporta negativos)
  if (comando.startsWith("GIRO:")) {
    String valorStr = comando.substring(5);
    int valor = valorStr.toInt();

    // Validar rango (-80 a 160)
    if (valor < -80) valor = -80;
    if (valor > 160) valor = 160;

    // Convertir a Ã¡ngulo de servo (0-180)
    // -80 -> servo 0, 0 -> servo 80, 160 -> servo 240 (limitado a 180)
    int anguloServo = valor + 80;  // Offset para que -80 sea 0
    if (anguloServo > 180) anguloServo = 180;
    if (anguloServo < 0) anguloServo = 0;

    Serial.print("ğŸ”„ Moviendo GIRO (Servo 13) a: ");
    Serial.print(valor);
    Serial.print("Â° (servo real: ");
    Serial.print(anguloServo);
    Serial.println("Â°)");

    // Movimiento directo (mÃ¡xima velocidad)
    servo13.write(anguloServo);
    posicionGiro = valor;

    delay(300);  // PequeÃ±a espera para que llegue

    Serial.println("âœ… GIRO completado");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // INCL:XXX - Mover servos 12 y 14 juntos (soporta negativos)
  // Los servos estÃ¡n espalda con espalda, por eso uno sube cuando el otro baja
  //
  // POSICIÃ“N NEUTRA (brazo hacia arriba): S12=135Â°, S14=45Â°
  //
  // Para inclinar hacia ADELANTE (+45Â°):
  //   S12: 135 - 45 = 90Â° (baja)
  //   S14: 45 + 45 = 90Â° (sube)
  //
  // Para inclinar hacia ATRÃS (-45Â°):
  //   S12: 135 - (-45) = 180Â° (sube)
  //   S14: 45 + (-45) = 0Â° (baja)
  //
  if (comando.startsWith("INCL:")) {
    String valorStr = comando.substring(5);
    int valor = valorStr.toInt();

    // Validar rango (-45 a 45)
    if (valor < -45) valor = -45;
    if (valor > 45) valor = 45;

    // Calcular posiciones desde la posiciÃ³n neutra (S12=135, S14=45)
    // S12 baja cuando inclinamos hacia adelante (valor positivo)
    // S14 sube cuando inclinamos hacia adelante (valor positivo)
    int pos12 = 135 - valor;  // +45 â†’ 90Â°, -45 â†’ 180Â°
    int pos14 = 45 + valor;   // +45 â†’ 90Â°, -45 â†’ 0Â°

    // Limitar a rangos vÃ¡lidos del servo (0-180)
    if (pos12 > 180) pos12 = 180;
    if (pos12 < 0) pos12 = 0;
    if (pos14 > 180) pos14 = 180;
    if (pos14 < 0) pos14 = 0;

    Serial.print("ğŸ”„ Moviendo INCLINACIÃ“N a: ");
    Serial.print(valor);
    Serial.println("Â°");
    Serial.print("   Servo 12: ");
    Serial.print(pos12);
    Serial.println("Â°");
    Serial.print("   Servo 14: ");
    Serial.print(pos14);
    Serial.println("Â°");

    servo12.write(pos12);
    servo14.write(pos14);
    posicionInclinacion = valor;

    delay(300);  // PequeÃ±a espera para que lleguen

    Serial.println("âœ… INCLINACIÃ“N completada");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // RESET - Volver a posiciÃ³n inicial
  if (comando == "RESET") {
    Serial.println("ğŸ”„ Reseteando a posiciÃ³n inicial...");

    servo13.write(0);
    servo12.write(135);
    servo14.write(45);
    posicionGiro = -80;
    posicionInclinacion = 0;

    delay(500);

    Serial.println("âœ… PosiciÃ³n inicial restaurada");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // Comando no reconocido
  Serial.println("âŒ Comando no reconocido");
  Serial.println("   Comandos vÃ¡lidos: PING, GIRO:XXX, INCL:XXX, RESET");
  SerialBT.println("ERROR");
  SerialBT.flush();
}

void mostrarPosicionActual() {
  Serial.println("\nğŸ“ PosiciÃ³n actual:");
  Serial.print("   GIRO (Servo 13): ");
  Serial.print(posicionGiro);
  Serial.println("Â°");
  Serial.print("   INCLINACIÃ“N: ");
  Serial.print(posicionInclinacion);
  Serial.print("Â° (S12:");
  Serial.print(135 - posicionInclinacion);
  Serial.print("Â°, S14:");
  Serial.print(45 + posicionInclinacion);
  Serial.println("Â°)");
  Serial.println("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES AUXILIARES PARA MOVIMIENTO DE SERVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Mover servo de GIRO (servo 13) a posiciÃ³n especificada
 * @param valor: posiciÃ³n deseada (-80 a 160)
 */
void moverGiro(int valor) {
  // Validar rango (-80 a 160)
  if (valor < -80) valor = -80;
  if (valor > 160) valor = 160;

  // Convertir a Ã¡ngulo de servo (0-180)
  int anguloServo = valor + 80;
  if (anguloServo > 180) anguloServo = 180;
  if (anguloServo < 0) anguloServo = 0;

  servo13.write(anguloServo);
  posicionGiro = valor;
}

/**
 * Mover servos de INCLINACIÃ“N (servos 12 y 14) a posiciÃ³n especificada
 * Los servos estÃ¡n espalda con espalda
 * @param valor: posiciÃ³n deseada (-45 a 45)
 */
void moverInclinacion(int valor) {
  // Validar rango (-45 a 45)
  if (valor < -45) valor = -45;
  if (valor > 45) valor = 45;

  // Calcular posiciones desde la posiciÃ³n neutra (S12=135, S14=45)
  int pos12 = 135 - valor;
  int pos14 = 45 + valor;

  // Limitar a rangos vÃ¡lidos del servo (0-180)
  if (pos12 > 180) pos12 = 180;
  if (pos12 < 0) pos12 = 0;
  if (pos14 > 180) pos14 = 180;
  if (pos14 < 0) pos14 = 0;

  servo12.write(pos12);
  servo14.write(pos14);
  posicionInclinacion = valor;
}
