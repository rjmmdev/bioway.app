#include "BluetoothSerial.h"
#include <ESP32Servo.h>

#if !defined(CONFIG_BT_ENABLED) || !defined(CONFIG_BLUEDROID_ENABLED)
#error Bluetooth is not enabled! Please run `make menuconfig` to enable it
#endif

BluetoothSerial SerialBT;
String dispositivoNombre = "ESP32_Detector";

// Pines para los tres servos
const int servo13Pin = 13;  // Servo de GIRO
const int servo12Pin = 12;  // Servo de INCLINACIÃ“N (trabaja con 14)
const int servo14Pin = 14;  // Servo de INCLINACIÃ“N (trabaja con 12)

// Objetos Servo
Servo servo13;
Servo servo12;
Servo servo14;

// Posiciones actuales (permiten negativos)
int posicionGiro = 0;        // Servo 13: -80 a 160
int posicionInclinacion = 0; // Servos 12 y 14: -48 a 48 (movimiento conjunto)

void setup() {
  Serial.begin(115200);

  // Configurar los tres servos
  // Servo 13: Rango mÃ¡ximo de pulso para mÃ¡ximo torque
  servo13.attach(servo13Pin, 400, 2600);
  servo12.attach(servo12Pin);
  servo14.attach(servo14Pin);

  // PosiciÃ³n inicial (brazo hacia arriba, permite +/-45Â° de inclinaciÃ³n)
  servo13.write(0);
  servo12.write(135);  // PosiciÃ³n neutra para permitir movimiento en ambas direcciones
  servo14.write(45);   // PosiciÃ³n neutra para permitir movimiento en ambas direcciones
  posicionGiro = 0;
  posicionInclinacion = 0;

  Serial.println("\n\n");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("       ESP32 BOTE BIOWAY - MODO PRUEBA SERVOS");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("Servos inicializados:");
  Serial.println("  - Servo 13 (GIRO): 0Â°");
  Serial.println("  - Servo 12 (INCLINACIÃ“N): 135Â° (neutro)");
  Serial.println("  - Servo 14 (INCLINACIÃ“N): 45Â° (neutro)");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("COMANDOS DISPONIBLES:");
  Serial.println("");
  Serial.println("  PING          â†’ Handshake (responde PONG)");
  Serial.println("");
  Serial.println("  GIRO:XXX      â†’ Mover servo 13 a posiciÃ³n XXX (-80 a 160)");
  Serial.println("                  Ejemplo: GIRO:90 o GIRO:-45");
  Serial.println("");
  Serial.println("  INCL:XXX      â†’ Mover servos 12 y 14 juntos (-45 a 45)");
  Serial.println("                  Servo 12: 135 - XXX");
  Serial.println("                  Servo 14: 45 + XXX");
  Serial.println("                  Ejemplo: INCL:45 o INCL:-45");
  Serial.println("");
  Serial.println("  GUARDAR       â†’ Muestra las posiciones actuales");
  Serial.println("                  para copiarlas al cÃ³digo principal");
  Serial.println("");
  Serial.println("  RESET         â†’ Volver a posiciÃ³n inicial (0, 0)");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  // Inicializar Bluetooth
  SerialBT.begin(dispositivoNombre);
  Serial.println("ğŸ“¡ Bluetooth: " + dispositivoNombre);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("âœ… MODO PRUEBA LISTO");
  Serial.println("â³ Esperando conexiÃ³n del celular...");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  // Verificar si hay datos disponibles por Bluetooth
  if (SerialBT.available()) {
    String comando = SerialBT.readStringUntil('\n');
    comando.trim();

    if (comando.length() > 0) {
      procesarComando(comando);
    }
  }

  // TambiÃ©n leer del Serial para pruebas locales
  if (Serial.available()) {
    String comando = Serial.readStringUntil('\n');
    comando.trim();

    if (comando.length() > 0) {
      procesarComando(comando);
    }
  }

  delay(50);
}

void procesarComando(String comando) {
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.print("ğŸ“¥ Comando recibido: ");
  Serial.println(comando);
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  // PING - Handshake
  if (comando == "PING") {
    SerialBT.println("PONG");
    SerialBT.flush();
    Serial.println("ğŸ¤ Handshake: PONG enviado");
    return;
  }

  // GIRO:XXX - Mover servo 13 (soporta negativos)
  if (comando.startsWith("GIRO:")) {
    String valorStr = comando.substring(5);
    int valor = valorStr.toInt();

    // Validar rango (-80 a 160)
    if (valor < -80) valor = -80;
    if (valor > 160) valor = 160;

    // Convertir a Ã¡ngulo de servo (0-180)
    // -80 -> servo 0, 0 -> servo 80, 160 -> servo 240 (limitado a 180)
    int anguloServo = valor + 80;  // Offset para que -80 sea 0
    if (anguloServo > 180) anguloServo = 180;
    if (anguloServo < 0) anguloServo = 0;

    Serial.print("ğŸ”„ Moviendo GIRO (Servo 13) a: ");
    Serial.print(valor);
    Serial.print("Â° (servo real: ");
    Serial.print(anguloServo);
    Serial.println("Â°)");

    // Movimiento directo (mÃ¡xima velocidad)
    servo13.write(anguloServo);
    posicionGiro = valor;

    delay(300);  // PequeÃ±a espera para que llegue

    Serial.println("âœ… GIRO completado");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // INCL:XXX - Mover servos 12 y 14 juntos (soporta negativos)
  // Los servos estÃ¡n espalda con espalda, por eso uno sube cuando el otro baja
  //
  // POSICIÃ“N NEUTRA (brazo hacia arriba): S12=135Â°, S14=45Â°
  //
  // Para inclinar hacia ADELANTE (+45Â°):
  //   S12: 135 - 45 = 90Â° (baja)
  //   S14: 45 + 45 = 90Â° (sube)
  //
  // Para inclinar hacia ATRÃS (-45Â°):
  //   S12: 135 - (-45) = 180Â° (sube)
  //   S14: 45 + (-45) = 0Â° (baja)
  //
  if (comando.startsWith("INCL:")) {
    String valorStr = comando.substring(5);
    int valor = valorStr.toInt();

    // Validar rango (-45 a 45)
    if (valor < -45) valor = -45;
    if (valor > 45) valor = 45;

    // Calcular posiciones desde la posiciÃ³n neutra (S12=135, S14=45)
    // S12 baja cuando inclinamos hacia adelante (valor positivo)
    // S14 sube cuando inclinamos hacia adelante (valor positivo)
    int pos12 = 135 - valor;  // +45 â†’ 90Â°, -45 â†’ 180Â°
    int pos14 = 45 + valor;   // +45 â†’ 90Â°, -45 â†’ 0Â°

    // Limitar a rangos vÃ¡lidos del servo (0-180)
    if (pos12 > 180) pos12 = 180;
    if (pos12 < 0) pos12 = 0;
    if (pos14 > 180) pos14 = 180;
    if (pos14 < 0) pos14 = 0;

    Serial.print("ğŸ”„ Moviendo INCLINACIÃ“N a: ");
    Serial.print(valor);
    Serial.println("Â°");
    Serial.print("   Servo 12: ");
    Serial.print(pos12);
    Serial.println("Â°");
    Serial.print("   Servo 14: ");
    Serial.print(pos14);
    Serial.println("Â°");

    servo12.write(pos12);
    servo14.write(pos14);
    posicionInclinacion = valor;

    delay(300);  // PequeÃ±a espera para que lleguen

    Serial.println("âœ… INCLINACIÃ“N completada");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // GUARDAR - Mostrar posiciones para copiar
  if (comando == "GUARDAR") {
    Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘         POSICIONES ACTUALES PARA COPIAR                   â•‘");
    Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    Serial.print("â•‘  Giro (Servo 13):        ");
    Serial.print(posicionGiro);
    Serial.println("Â°                            â•‘");
    Serial.print("â•‘  InclinaciÃ³n:            ");
    Serial.print(posicionInclinacion);
    Serial.println("Â°                            â•‘");
    Serial.print("â•‘  â†’ Servo 12:             ");
    Serial.print(135 - posicionInclinacion);
    Serial.println("Â°                           â•‘");
    Serial.print("â•‘  â†’ Servo 14:             ");
    Serial.print(45 + posicionInclinacion);
    Serial.println("Â°                            â•‘");
    Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    Serial.println("â•‘  CÃ³digo para ESP32_BoteBioWay.txt:                        â•‘");
    Serial.println("â•‘                                                           â•‘");
    Serial.print("â•‘  servo13.write(");
    Serial.print(posicionGiro);
    Serial.println(");  // Giro                           â•‘");
    Serial.print("â•‘  servo12.write(");
    Serial.print(135 - posicionInclinacion);
    Serial.println("); // InclinaciÃ³n                      â•‘");
    Serial.print("â•‘  servo14.write(");
    Serial.print(45 + posicionInclinacion);
    Serial.println(");  // InclinaciÃ³n                      â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // Enviar al celular en formato simple
    String respuesta = "GIRO:" + String(posicionGiro) + ",INCL:" + String(posicionInclinacion);
    SerialBT.println(respuesta);
    SerialBT.flush();
    return;
  }

  // RESET - Volver a posiciÃ³n inicial
  if (comando == "RESET") {
    Serial.println("ğŸ”„ Reseteando a posiciÃ³n inicial...");

    servo13.write(0);
    servo12.write(135);
    servo14.write(45);
    posicionGiro = -80;
    posicionInclinacion = 0;

    delay(500);

    Serial.println("âœ… PosiciÃ³n inicial restaurada");
    SerialBT.println("OK");
    SerialBT.flush();

    mostrarPosicionActual();
    return;
  }

  // Comando no reconocido
  Serial.println("âŒ Comando no reconocido");
  Serial.println("   Comandos vÃ¡lidos: PING, GIRO:XXX, INCL:XXX, GUARDAR, RESET");
  SerialBT.println("ERROR");
  SerialBT.flush();
}

void mostrarPosicionActual() {
  Serial.println("\nğŸ“ PosiciÃ³n actual:");
  Serial.print("   GIRO (Servo 13): ");
  Serial.print(posicionGiro);
  Serial.println("Â°");
  Serial.print("   INCLINACIÃ“N: ");
  Serial.print(posicionInclinacion);
  Serial.print("Â° (S12:");
  Serial.print(135 - posicionInclinacion);
  Serial.print("Â°, S14:");
  Serial.print(45 + posicionInclinacion);
  Serial.println("Â°)");
  Serial.println("");
}
